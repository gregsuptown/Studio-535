# Render Deployment Guide - Studio 535

**Deployment Order**: Render (3) â†’ Vercel (1) â†’ Fly.io (4) â†’ Railway (2)

**Current Step**: ğŸ¯ **Render Deployment (Option 3)**

---

## ğŸ“‹ Prerequisites

Before deploying to Render, ensure you have:

- [ ] GitHub repository: `gregsuptown/Studio-535`
- [ ] Render account (Sign up at https://render.com - free tier available)
- [ ] TiDB Cloud database running
- [ ] Manus OAuth credentials
- [ ] Stripe API keys (test or live)
- [ ] AWS S3 or Cloudflare R2 credentials

---

## ğŸš€ Step 1: Deploy to Render

### A. Connect GitHub Repository

1. **Go to Render Dashboard**: https://dashboard.render.com/
2. **Click "New +"** in the top right
3. **Select "Web Service"**
4. **Connect GitHub Account** (if not already connected)
5. **Select Repository**: `gregsuptown/Studio-535`
6. **Configure Service**:
   - **Name**: `studio535`
   - **Region**: `Oregon` (or closest to your users)
   - **Branch**: `main` (or your production branch)
   - **Root Directory**: Leave blank
   - **Runtime**: `Node`
   - **Build Command**:
     ```bash
     pnpm install --frozen-lockfile && pnpm build
     ```
   - **Start Command**:
     ```bash
     node dist/index.js
     ```
   - **Plan**: Free (or upgrade to Starter $7/month for better performance)

### B. Configure Environment Variables

In the Render dashboard, add these environment variables:

#### **Critical Variables** (Required for app to work):

```bash
# Frontend URL - IMPORTANT: Use your actual Render URL
VITE_FRONTEND_URL=https://studio535.onrender.com

# Database
DATABASE_URL=mysql://[username]:[password]@[host]:4000/[database]?ssl={"rejectUnauthorized":true}

# JWT Secret (click "Generate" in Render)
JWT_SECRET=[Auto-generated by Render]

# Manus OAuth
VITE_OAUTH_PORTAL_URL=https://oauth.manus.im
VITE_APP_ID=[Get from Manus dashboard]
OWNER_OPEN_ID=[Get from Manus dashboard]

# Stripe (test keys for now)
STRIPE_SECRET_KEY=sk_test_...
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_WEBHOOK_SECRET=[Configure after deployment]

# S3 or Cloudflare R2
S3_BUCKET_NAME=studio535-uploads
S3_REGION=us-west-2
S3_ACCESS_KEY_ID=[Your S3/R2 access key]
S3_SECRET_ACCESS_KEY=[Your S3/R2 secret key]
# S3_ENDPOINT=https://[your-account-id].r2.cloudflarestorage.com  # Only for Cloudflare R2

# Email
RESEND_API_KEY=[Your Resend API key]

# App Config
VITE_APP_TITLE=Studio 535
NODE_ENV=production
PORT=10000
```

#### **How to Set Environment Variables in Render**:

1. In your service settings, scroll to **"Environment"**
2. Click **"Add Environment Variable"**
3. For each variable:
   - Enter the **Key** (e.g., `VITE_FRONTEND_URL`)
   - Enter the **Value**
   - For secrets like `STRIPE_SECRET_KEY`, they'll be encrypted automatically

**âš¡ Quick Tip**: For `JWT_SECRET`, click the **"Generate"** button to create a secure random value.

### C. Deploy the Service

1. **Click "Create Web Service"**
2. **Wait for Build**: Initial build takes 5-10 minutes
   - Watch the logs in real-time
   - Look for `Build successful` message
3. **Check Deployment Status**:
   - Once deployed, you'll see: `Your service is live at https://studio535.onrender.com`
   - Health check should show green

---

## ğŸ” Step 2: Verify Deployment

### A. Check Health Endpoint

Open in browser: `https://studio535.onrender.com/api/health`

**Expected Response**:
```json
{"status": "ok"}
```

If you see this, your backend is working! âœ…

### B. Test Frontend

Open: `https://studio535.onrender.com`

You should see the Studio 535 landing page.

### C. Check Logs

In Render dashboard:
1. Go to your service
2. Click **"Logs"** tab
3. Look for:
   ```
   Server running on port 10000
   Database connected
   ```

---

## âš™ï¸ Step 3: Post-Deployment Configuration

### A. Run Database Migrations

Render doesn't automatically run migrations. You need to trigger them:

**Option 1: Via Render Shell** (Recommended)
1. In Render dashboard, click **"Shell"** tab
2. Run:
   ```bash
   node -e "require('./dist/db.js').db.schema.sync()"
   ```

**Option 2: Via Build Command**
Update your build command to:
```bash
pnpm install --frozen-lockfile && pnpm build && pnpm db:push
```

### B. Configure Stripe Webhook

1. **Get Render URL**: `https://studio535.onrender.com`
2. **Go to Stripe Dashboard**: https://dashboard.stripe.com/webhooks
3. **Add Endpoint**:
   - **URL**: `https://studio535.onrender.com/api/stripe/webhook`
   - **Events to listen to**:
     - `checkout.session.completed`
     - `payment_intent.succeeded`
     - `payment_intent.payment_failed`
4. **Copy Signing Secret**: `whsec_...`
5. **Update Render Env Var**:
   - Go to Render dashboard
   - Update `STRIPE_WEBHOOK_SECRET` with the new value
   - Click **"Save Changes"** (will trigger redeploy)

### C. Configure Manus OAuth Redirect

1. **Go to Manus Dashboard**: https://dev.manus.im
2. **Update OAuth Settings**:
   - **Redirect URI**: `https://studio535.onrender.com/auth/callback`
   - **Allowed Origins**: `https://studio535.onrender.com`
3. **Copy** `VITE_APP_ID` and `OWNER_OPEN_ID`
4. **Update Render Env Vars** with these values

---

## ğŸ› Troubleshooting Common Render Issues

### Issue 1: Build Fails with "pnpm: command not found"

**Solution**: Add this to your build command:
```bash
npm install -g pnpm@10 && pnpm install --frozen-lockfile && pnpm build
```

### Issue 2: App Crashes with "Cannot find module './dist/index.js'"

**Cause**: Build didn't complete successfully

**Solution**:
1. Check build logs for TypeScript errors
2. Verify `tsconfig.json` is correct
3. Ensure `pnpm build` runs locally without errors

### Issue 3: "502 Bad Gateway" or Service Unavailable

**Cause**: App crashed after starting

**Solution**:
1. Check **Logs** tab in Render dashboard
2. Look for error messages
3. Common causes:
   - Missing environment variables
   - Database connection failed
   - Port binding issues

**Fix**: Ensure `PORT=10000` is set and app listens on `process.env.PORT`

### Issue 4: Cold Starts (Free Tier)

**Symptom**: First request after inactivity takes 30+ seconds

**Cause**: Render free tier spins down after 15 minutes of inactivity

**Solutions**:
- **Option A**: Upgrade to Starter plan ($7/month) - no cold starts
- **Option B**: Use a cron job to ping your app every 14 minutes:
  - Service: https://cron-job.org
  - URL: `https://studio535.onrender.com/api/health`
  - Schedule: Every 14 minutes

### Issue 5: Static Assets (CSS/JS) Not Loading

**Cause**: Incorrect Vite configuration for production

**Solution**: Already handled in `vite.config.ts`, but verify:
```typescript
build: {
  outDir: path.resolve(import.meta.dirname, "dist/public"),
  emptyOutDir: true,
}
```

### Issue 6: Environment Variables Not Taking Effect

**Cause**: Render caches builds

**Solution**:
1. After changing env vars, click **"Manual Deploy"**
2. Select **"Clear build cache & deploy"**

---

## ğŸ“Š Render vs Other Options

| Feature | Render (Free) | Render (Starter) | Vercel | Railway | Fly.io |
|---------|---------------|------------------|--------|---------|---------|
| Cost | $0 | $7/month | $20/month | $5-10/month | $5-10/month |
| Cold Starts | Yes (15 min) | No | No | No | No |
| Build Time | 5-10 min | 5-10 min | 2-5 min | 3-7 min | 3-7 min |
| Auto-deploy | âœ… | âœ… | âœ… | âœ… | âœ… |
| Custom Domain | âœ… | âœ… | âœ… | âœ… | âœ… |
| SSL Certificate | âœ… Free | âœ… Free | âœ… Free | âœ… Free | âœ… Free |
| Health Checks | âœ… | âœ… | âš ï¸ Limited | âœ… | âœ… |
| Shell Access | âœ… | âœ… | âŒ | âœ… | âœ… |
| Database Included | âŒ | âŒ | âŒ | âœ… | âœ… |

---

## âœ… Success Checklist

After deployment, verify these work:

- [ ] **Health Check**: `https://studio535.onrender.com/api/health` returns 200
- [ ] **Frontend Loads**: `https://studio535.onrender.com` shows landing page
- [ ] **Authentication**: Can log in with Manus OAuth
- [ ] **Create Project**: Can submit intake form
- [ ] **File Upload**: Can upload attachments
- [ ] **Payments**: Stripe checkout works (test mode)
- [ ] **Admin Dashboard**: Admin can view all projects
- [ ] **Authorization**: Users can only see their own projects

---

## ğŸ”„ If Render Fails - Next Steps

Based on your deployment order: **3 â†’ 1 â†’ 4 â†’ 2**

### When to Move to Vercel (Option 1):

Move to Vercel if you experience:
- âŒ Build takes longer than 15 minutes
- âŒ Cold starts are unacceptable (free tier limitation)
- âŒ Complex deployment issues that take > 30 minutes to debug
- âŒ Render's build process fails repeatedly

**Switch Command**:
```bash
# Vercel is already configured (vercel.json exists)
# See DEPLOYMENT_STATUS.md for Vercel instructions
```

### When to Move to Fly.io (Option 4):

Move to Fly.io if:
- âŒ Both Render and Vercel fail
- âŒ You need more control over deployment (Docker)
- âŒ You want to host in specific regions

### When to Move to Railway (Option 2):

Move to Railway if:
- âŒ All other options fail
- âŒ You want the simplest possible deployment
- âŒ You need a bundled database

---

## ğŸ“ Next Steps After Render Deployment

1. **Test Thoroughly**: Run through the success checklist above
2. **Monitor Logs**: Watch for errors in the first 24 hours
3. **Update DNS**: Point your custom domain to Render (if applicable)
4. **Enable Metrics**: Set up monitoring in Render dashboard
5. **Backup Plan**: Keep Vercel option ready as fallback

---

## ğŸ†˜ Getting Help

If you encounter issues:

1. **Check Render Logs**: Most issues show up here
2. **Render Community**: https://community.render.com
3. **Render Status**: https://status.render.com (check for outages)
4. **Fallback to Vercel**: See `DEPLOYMENT_STATUS.md` for instructions

---

## ğŸ“ Deployment Files Created

- âœ… `render.yaml` - Infrastructure as Code configuration
- âœ… `RENDER_DEPLOYMENT.md` - This guide
- âœ… `vercel.json` - Vercel fallback config (Option 1)
- âœ… `.github/workflows/ci.yml` - CI/CD pipeline

---

**Ready to deploy? Follow the steps above and let's get Studio 535 live on Render!** ğŸš€

**Estimated Time**: 20-30 minutes (including environment variable setup)

---

## ğŸ¯ Quick Start Commands

```bash
# 1. Commit render.yaml to your repository
git add render.yaml RENDER_DEPLOYMENT.md
git commit -m "Add Render deployment configuration"
git push origin claude/code-review-improvements-011foez2e7B7VVxWdxGnWLDp

# 2. Merge to main branch
git checkout main
git merge claude/code-review-improvements-011foez2e7B7VVxWdxGnWLDp
git push origin main

# 3. Go to Render dashboard and connect repository
# https://dashboard.render.com/
```

**After these commands, follow the "Step 1: Deploy to Render" section above.**
